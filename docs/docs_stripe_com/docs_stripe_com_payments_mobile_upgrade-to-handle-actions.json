{
  "content": "# Migrate your basic card integration\n\n## Migrate your mobile app to an integration that can handle bank requests for card authentication.\n\niOSAndroidReact Native\nIf you followed the [Card payments without bank\nauthentication](https://docs.stripe.com/payments/without-card-authentication)\nguide, your integration creates payments that decline when a bank asks the\ncustomer to authenticate the purchase.\n\nIf you start seeing many failed payments like the one in the Dashboard below or\nwith an error code of `requires_action_not_handled` in the API, upgrade your\nbasic integration to handle, rather than decline, these payments.\n\n![Dashboard showing a failed payment that says that this bank required\nauthentication for this\npayment](https://b.stripecdn.com/docs-statics-srv/assets/failed-payment-dashboard.9e22ec31f3c7063665911e26e389c5dc.png)\n\nUse this guide to learn how to upgrade the integration you built in the previous\nguide to add server and client code that prompts the customer to authenticate\nthe payment by displaying a modal.\n\n#### Note\n\nSee a [full\nsample](https://github.com/stripe-samples/accept-a-payment/tree/master/custom-payment-flow)\nof this integration on GitHub.\n\n[Check if the payment requires\nauthenticationServer-side](https://docs.stripe.com/payments/mobile/upgrade-to-handle-actions#update-server)\nMake three changes to the endpoint on your server that creates the\nPaymentIntent:\n\n- **Remove** the\n[error_on_requires_action](https://docs.stripe.com/api/payment_intents/create#create_payment_intent-error_on_requires_action)\nparameter to no longer fail payments that require authentication. Instead, the\nPaymentIntent status changes to `requires_action`.\n- **Add** the `confirmation_method` parameter to indicate that you want to\nexplicitly (manually) confirm the payment again on the server after handling\nauthentication requests.\n- **Add** the\n[use_stripe_sdk](https://docs.stripe.com/api/payment_intents/confirm#confirm_payment_intent-use_stripe_sdk)\nparameter to enable your mobile client to handle additional authentication\nsteps.\n\n```\ncurl https://api.stripe.com/v1/payment_intents \\\n -u sk_test_BQokikJOvBiI2HlWgH4olfQ2: \\\n -d amount=1099 \\\n -d currency=usd \\\n -d payment_method_types[]=card \\\n -d confirm=true \\\n -d error_on_requires_action=true \\\n -d payment_method=\"{{PAYMENT_METHOD_ID}}\" \\\n -d confirmation_method=manual\n```\n\nThen update your “generate response” function to handle the `requires_action`\nstate instead of erroring:\n\n```\n# If the request succeeds, check the\n# PaymentIntent's `status` and handle\n# its `next_action`.\n```\n\n[Ask the customer to\nauthenticateClient-side](https://docs.stripe.com/payments/mobile/upgrade-to-handle-actions#update-client)\nNext, update your Android code to tell Stripe to show a modal if the customer\nneeds to authenticate.\n\nUse `handleNextActionForPayment` when a PaymentIntent has a status of\n`requires_action`. If successful, the PaymentIntent will have a status of\n`requires_confirmation` and you need to confirm the PaymentIntent again on your\nserver to finish the payment.\n\n```\npublic class CheckoutActivity extends Activity {\n private Stripe stripe;\n\n @Override\n protected void onCreate(@Nullable Bundle savedInstanceState) {\n super.onCreate(savedInstanceState);\n stripe = new Stripe(this, \"pk_test_TYooMQauvdEDq54NiTphI7jx\");\n }\n private void handleResponse(@NonNull JSONObject json) throws JSONException {\n if (json.has(\"error\")) {\n // Display the error to the customer\n final String error = json.getString(\"error\");\n } else if (json.has(\"requiresAction\")) {\n final String clientSecret = json.getString(\"clientSecret\");\n stripe.handleNextActionForPayment(this, clientSecret);\n } else {\n // Display success message\n }\n }\n @Override\nprotected void onActivityResult(int requestCode, int resultCode, @Nullable\nIntent data) {\n super.onActivityResult(requestCode, resultCode, data);\n\n stripe.onPaymentResult(requestCode, data,\n new ApiResultCallback<PaymentIntentResult>() {\n @Override\n public void onSuccess(@NonNull PaymentIntentResult result) {\n switch (result.getOutcome()) {\n case StripeIntentResult.Outcome.SUCCEEDED: {\n // The card action has been handled\n// Send the Payment Intent ID to your server and confirm it again\n }\n case StripeIntentResult.Outcome.CANCELED: {\n // Canceled\n }\n case StripeIntentResult.Outcome.TIMEDOUT: {\n // Timed-out\n }\n case StripeIntentResult.Outcome.FAILED: {\n // Failed\n }\n }\n }\n\n @Override\n public void onError(@NonNull Exception e) {\n // Error encountered\n }\n }\n );\n }\n}\n```\n\n[Confirm the PaymentIntent\nagainServer-side](https://docs.stripe.com/payments/mobile/upgrade-to-handle-actions#update-server-second-confirm)\nUsing the same endpoint you set up earlier, confirm the PaymentIntent again to\nfinalize the payment and fulfill the order. The payment attempt fails and\ntransitions back to `requires_payment_method` if it is not confirmed again\nwithin one hour.\n\n```\ncurl https://api.stripe.com/v1/payment_intents/{{PAYMENT_INTENT_ID}}/confirm \\\n -u sk_test_BQokikJOvBiI2HlWgH4olfQ2: \\\n -X \"POST\"\n```\n\n[Test the\nintegration](https://docs.stripe.com/payments/mobile/upgrade-to-handle-actions#test-manual)\nUse our test cards in a sandbox to verify that your integration was properly\nupdated. Stripe displays a fake authentication page inside the modal in a\nsandbox that lets you simulate a successful or failed authentication attempt. In\nlive mode the bank controls the UI of what is displayed inside the modal.\n\nNumberDescription4242424242424242Succeeds and immediately processes the\npayment.4000000000009995Always fails with a decline code of\n`insufficient_funds`.4000002500003155Requires authentication, which in this\nintegration will fail with a decline code of `authentication_not_handled`.\n\n## Links\n\n- [Card payments without bank\nauthentication](https://docs.stripe.com/payments/without-card-authentication)\n- [full\nsample](https://github.com/stripe-samples/accept-a-payment/tree/master/custom-payment-flow)\n-\n[error_on_requires_action](https://docs.stripe.com/api/payment_intents/create#create_payment_intent-error_on_requires_action)\n-\n[use_stripe_sdk](https://docs.stripe.com/api/payment_intents/confirm#confirm_payment_intent-use_stripe_sdk)",
  "metadata": {
    "title": "Migrate your basic card integration | Stripe Documentation",
    "description": "Migrate your mobile app to an integration that can handle bank requests for card authentication.",
    "sourceURL": "https://docs.stripe.com/payments/mobile/upgrade-to-handle-actions"
  }
}