{
  "content": "# Querying authentication conversion\n\n## Use Stripe Sigma to retrieve information about authentication, conversion, and the SCA exemptions used.\n\nSee the `authentication_report_attempts` table under the **Analytics Tables**\nsection of the Sigma schema. Each row within the\n`authentication_report_attempts` table represents data about an individual\nattempt object. Our [full-page\ndocumentation](https://dashboard.stripe.com/stripe-schema?tableName=authentication_report_attempts)\nalso shows the schema in a split-view format.\n\n## Attempt conversion information\n\nYou can get a report for every attempt, with each\n[PaymentIntent](https://docs.stripe.com/api/payment_intents) or\n[SetupIntent](https://docs.stripe.com/api/payment_intents) having possibly more\nthan one attempt.\n\n#### Note\n\nIn some cases there are multiple attempts for a single transaction, such as when\na payment is declined and then retried. To filter to a specific transaction, use\nthe `is_final_attempt` column. This column is eventually consist after a few\ndays.\n\nThe following example query uses the `authentication_report_attempts` table to\nretrieve a list of payment intents that were successfully authenticated using\nthe challenge flow.\n\n```\nselect\n attempt_id,\n intent_id,\n payment_method,\n threeds_reason as step_up_reason,\n charge_outcome\nfrom authentication_report_attempts\nwhere intent_type = 'payment'\n and threeds_outcome_result = 'authenticated'\n and authentication_flow = 'challenge'\n and is_final_attempt\nlimit 5\n```\n\nattempt_idintent_idpayment_methodstep_up_reasoncharge_outcomepayatt_1IRdZ9F…pi_1Hn8d…card_chargerequested_by_radar_ruleauthorizedpayatt_1I4AFxF…pi_1J8Ljt…card_chargerequested_by_radar_ruleauthorizedpayatt_1HvmxU…pi_1HhsH…card_chargerequested_by_radar_ruleauthorizedpayatt_1I5npGF…pi_1IdKak…card_chargerequested_by_radar_ruleauthorizedpayatt_1HcbWZ…pi_1IAhBh…card_chargerequested_by_radar_ruleauthorized\n## SCA exemption information\n\nYou can also query information on the [SCA\nexemptions](https://stripe.com/guides/strong-customer-authentication#exemptions-to-strong-customer-authentication)\nused by Stripe or the issuing bank. See [Exemptions to Strong Customer\nAuthentication](https://stripe.com/guides/strong-customer-authentication#exemptions-to-strong-customer-authentication).\n\nThe following query shows the payments that used a low risk direct authorization\nSCA exemption that was declined for a reason unrelated to the requested\nexemption.\n\n```\nselect\n attempt_id,\n intent_id,\n charge_outcome,\n charge_outcome_reason\nfrom authentication_report_attempts\nwhere intent_type = 'payment'\n and sca_exemption_requested = 'low_risk'\n and sca_exemption_mechanism = 'authorization' -- direct to authorization\n and sca_exemption_status = 'non_sca_decline'\n and is_final_attempt\nlimit 5\n```\n\nattempt_idintent_idcharge_outcomecharge_outcome_reasonpayatt_3JeL…pi_3JeL…issuer_declinedinsufficient_fundspayatt_1Itw…pi_1Itw…issuer_declineddo_not_honorpayatt_1Ini3…pi_1Ini3…issuer_declineddo_not_honorpayatt_1IiO7…pi_1IiO7…issuer_declineddo_not_honorpayatt_1I0hGm…pi_1I0hGk…issuer_declinedinsufficient_funds\n## Impact of deduplication\n\nThe following query shows how removing duplicates with `is_final_attempt`\naffects the calculation of the authentication rate for setups.\n\n#### Note\n\nOur deduplication logic looks for groups of declined transactions (except for\nthe last, potentially) with the same `customer_id​`, `currency`, and `amount​`,\nappearing close together in time. Such groups are treated as a single unit for\nconversion calculations. In the Sigma table, we include all raw data, but also\ninclude a column, `is_final_attempt​`, that you can use to filter to a\nrepresentative transaction from each group.\n\n```\nwith setup_attempts as (\n select\n created,\n is_final_attempt,\n threeds_outcome_result in (\n 'attempt_acknowledged',\n 'authenticated',\n 'delegated',\n 'exempted'\n ) as threeds_succeeded\n from authentication_report_attempts\n where created between date'2021-10-29' and date'2021-11-03'\n and intent_type = 'setup'\n and is_threeds_triggered\n)\nselect\n date_trunc('day', created) as day,\n 1. * count_if(threeds_succeeded)\n / count(*) as authentication_rate__raw,\n 2. * count_if(threeds_succeeded and is_final_attempt)\n / nullif(count_if(is_final_attempt), 0) as authentication_rate__deduped\nfrom setup_attempts\ngroup by 1\norder by 1\n```\n\ndayauthentication_rate__rawauthentication_rate__deduped2021-10-290.590.802021-10-300.600.812021-10-310.590.812021-11-010.610.832021-11-020.620.83\n\n## Links\n\n- [full-page\ndocumentation](https://dashboard.stripe.com/stripe-schema?tableName=authentication_report_attempts)\n- [PaymentIntent](https://docs.stripe.com/api/payment_intents)\n- [SCA\nexemptions](https://stripe.com/guides/strong-customer-authentication#exemptions-to-strong-customer-authentication)",
  "metadata": {
    "title": "Querying authentication conversion | Stripe Documentation",
    "description": "Use Stripe Sigma to retrieve information about authentication, conversion, and the SCA exemptions used.",
    "sourceURL": "https://docs.stripe.com/payment-authentication/writing-queries"
  }
}