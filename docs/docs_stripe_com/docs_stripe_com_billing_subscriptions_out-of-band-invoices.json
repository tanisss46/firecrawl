{
  "content": "# Out-of-band invoices\n\n## Learn how to mark invoices as paid off of Stripe.\n\nWhen you submit payments to a third-party processor based on Stripe invoices,\nyour system records the invoices as `paid_out_of_band`. The rest of Billing’s\nsubscription cycle continues normally. You’ll customize two key Stripe Billing\nworkflows:\n\n- Collecting customers’ payment method details\n- Paying invoices\n\n## Request Flow\n\nThe following diagrams illustrate the high-level request flows of a\nmultiprocessor integration.\n\n### Collecting and storing customers’ payment method details\n\nCustomer\n\nServer\n\nStripe\n\nThird party\n\nStart signup\n\nCreate customer & subscription\n\nStripe creates invoice\n\nRetrieve amount\n\nStart checkout flow\n\nCollect payment method details\n\nRetrieve payment method token\n\nStore metadata on customer\n\n### Paying invoices\n\nCustomer\n\nServer\n\nStripe\n\nThird party\n\nStripe creates invoice automatically\n\nRetrieve invoice details\n\nProcess payment\n\nListen for successful payment\n\nMark invoice as paid\n\n## Configure Stripe\n\nTo set up a multiprocessor integration, you have to make some configuration\nchanges to Stripe.\n\n### Disable invoice emails\n\nTo prevent customers from paying directly on Stripe, disable automatic emails\nfor any customer who processes payments on a third-party provider. To disable\nautomatic emails:\n\n- Disable **Send finalized invoices and credit notes to customers** in Stripe’s\n[automatic billing\nsettings](https://dashboard.stripe.com/settings/billing/automatic). After you\nchange this setting, changes to any subscription with\n[collection_method](https://docs.stripe.com/api/subscriptions/object#subscription_object-collection_method)\nset to `send_invoice` won’t trigger customer emails. Only use this if all of\nyour emailed subscription invoices are paid with a third-party payment provider.\n\n### Configure the customer portal\n\nIf you use the [customer\nportal](https://docs.stripe.com/customer-management#customer-portal-features),\ndisable **Allow customers to view and update payment methods** in the [customer\nportal settings](https://dashboard.stripe.com/settings/billing/portal). (You\nalso need to disable the **Customers can switch plans** setting.) You need to\nbuild custom flows to allow users to self-serve updates to their payment method\non a third-party processor.\n\n[Sign up new\ncustomers](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#sign-up-new-customers)\n### Create a Stripe customer\n\nFirst create a blank [Customer](https://docs.stripe.com/api/customers) record on\nStripe.\n\n```\ncurl -X POST https://api.stripe.com/v1/customers \\\n -u \"sk_test_BQokikJOvBiI2HlWgH4olfQ2:\"\n```\n\n### Create a subscription\n\nNext, create a [Subscription](https://docs.stripe.com/api/subscription) and set\nthe `collection_method` to `send_invoice`. This setting doesn’t require a Stripe\npayment method and generates [Invoices](https://docs.stripe.com/api/invoice)\nthat must be paid directly instead. Set the `days_until_due` parameter to the\nnumber of days an unpaid invoice remains open before your [configured failed\npayment\nlogic](https://docs.stripe.com/billing/subscriptions/overview#failed-payments)\nactivates. You’re responsible for retrying failed payments on the third-party\nprovider, and you need to set this long enough so that any recovery workflows\nyou implement have time to complete.\n\n```\ncurl https://api.stripe.com/v1/subscriptions \\\n -u \"sk_test_BQokikJOvBiI2HlWgH4olfQ2:\" \\\n -d \"items[0][price]\"={{PRICE_ID}} \\\n -d customer={{CUSTOMER_ID}} \\\n -d collection_method=send_invoice \\\n -d days_until_due=30\n```\n\n### Present the amount to the user for payment\n\nThird-party payments don’t work with [Stripe\nCheckout](https://docs.stripe.com/payments/checkout) or\n[Elements](https://docs.stripe.com/payments/elements). You have to build a\ncheckout flow that uses the third party to create a valid payment method but\nwith Stripe as the source of truth for billable amounts. To determine the amount\nto charge in the checkout flow, [retrieve the initial\ninvoice](https://docs.stripe.com/api/invoices/retrieve) generated by the\nsubscription.\n\n### Collect payment method details Third party\n\nFollow the instructions from the third-party payment provider to collect payment\nmethod details from customers. Make sure to set up payment methods for use in\nfuture or off-session transactions.\n\nThe output of this step varies by processor. Some third-party processors provide\na payment method token that you use to generate payments on that processor.\n\n### Update the Customer object\n\nUpdate the Customer record created in the [first\nstep](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#create-customer)\nof the subscription creation flow. For convenience, store non-sensitive\nthird-party tokens as\n[metadata](https://docs.stripe.com/api/customers/object#customer_object-metadata)\non the Customer record.\n\nRemember to turn off the **Send finalized invoices and credit notes to\ncustomers** option before setting the `email` property on the Customer.\n\n```\ncurl https://api.stripe.com/v1/customers/{{CUSTOMER_ID}} \\\n -u \"sk_test_BQokikJOvBiI2HlWgH4olfQ2:\" \\\n -d description=\"Third-party payment customer\" \\\n -d \"metadata[third_party_customer_id]\"={{THIRD_PARTY_CUSTOMER_ID}} \\\n -d \"metadata[third_party_payment_method_id]\"={{THIRD_PARTY_PAYMENT_METHOD_ID}}\n```\n\n[Collect\npayment](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#collect-payment)\n### Listen for `invoice.created` [webhook](https://docs.stripe.com/webhooks) events\n\nAll invoices (including the first invoice created from a subscription) start in\na draft state and trigger\n[invoice.created](https://docs.stripe.com/api/events/types#event_types-invoice.created)\nwebhooks. Invoices created by a subscription are automatically finalized after 1\nhour to give time for integrations to modify the draft invoice. [Finalize the\ninvoice manually](https://docs.stripe.com/api/invoices/finalize) to skip this\ndelay.\n\nInvoice finalization triggers an\n[invoice.finalized](https://docs.stripe.com/api/events/types#event_types-invoice.finalized)\nevent. [Listen to this\nevent](https://docs.stripe.com/billing/subscriptions/webhooks) to trigger\npayments on the third-party processor.\n\n### Process payments Third party\n\nFollow the instructions from the third-party payment provider to collect\npayments for the amounts represented on each invoice using the tokens stored on\nthe associated Customer record. This might include listening to webhooks from\nthe third party for notifications of successful payments.\n\n### Mark the Stripe Invoice as paid out-of-band\n\nWhen payment on the third party is successful, mark the corresponding invoice as\n`paid_out_of_band`.\n\n```\ncurl https://api.stripe.com/v1/invoices/{{INVOICE_ID}}/pay \\\n -u \"sk_test_BQokikJOvBiI2HlWgH4olfQ2:\" \\\n -d paid_out_of_band=true\n```\n\nMark the invoice as paid before the subscription’s payment due date to keep the\nsubscription operating normally. The Subscription object’s\n[days_until_due](https://docs.stripe.com/api/subscriptions/object#subscription_object-days_until_due)\nattribute defines the payment due date.\n\n[Handle state\nchanges](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#handle-state-changes)\n### Stripe Subscription cancellation\n\nTo cancel Subscriptions, remove third-party payment method details from Stripe’s\nCustomer records and your database. Listen for the\n[customer.subscription.deleted](https://docs.stripe.com/api/events/types#event_types-customer.subscription.deleted)\nevent and delete any tokens related to the canceled subscription.\n\n### Third-party payment cancellation Third party\n\nSome third-party payment processors allow end customers to cancel billing\nagreements directly. If the processor allows this, listen for any associated\nevents and then [cancel the\nsubscription](https://docs.stripe.com/api/subscriptions/cancel) on Stripe.\n\n### Refunds and disputes Third party\n\nYou’re responsible for processing refunds and disputes originating from the\nthird-party processor. To maintain accurate accounting data, use [Credit\nNotes](https://docs.stripe.com/api/credit_notes/object) to adjust the amounts on\nissued invoices to log refunds. Create a Credit Note, and set the\n[out_of_band_amount](https://docs.stripe.com/api/credit_notes/create#create_credit_note-out_of_band_amount)\nto the refunded amount.\n\n[Other\nconsiderations](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#other-considerations)\n### Switching between third-party payments and Stripe\n\nTo switch a customer from a third-party processor to Stripe:\n\n- Collect a new payment method for the customer by [setting up future\npayments](https://docs.stripe.com/payments/save-and-reuse?platform=checkout) or\nusing the [Customer Portal](https://docs.stripe.com/no-code/customer-portal).\n- Update the subscription\n[collection_method](https://docs.stripe.com/api/subscriptions/update#update_subscription-collection_method)\nfrom `send_invoice` to `charge_automatically` and set the new payment method as\nthe `default_payment_method`.\n- Delete any existing third-party payment method tokens.\n\n### Retries\n\nYou must handle any recovery of failed third-party payments yourself. Stripe\ndoesn’t have any visibility into the state of third-party payments until you\nmark an invoice as paid.\n\n### Taxes\n\nStripe Tax automatically adds the correct tax amounts to invoices as long as you\nset a billing postal code or IP address when [updating the Customer record after\ncheckout](https://docs.stripe.com/billing/subscriptions/out-of-band-invoices#update-customer).\n\n### Partial Payments\n\nWe don’t support partial payments on `out_of_band` invoices. In the event of a\npartial payment, use a Credit Note to adjust the original invoice then manually\ngenerate a new invoice for any remaining balance.\n\n## Links\n\n- [automatic billing\nsettings](https://dashboard.stripe.com/settings/billing/automatic)\n-\n[collection_method](https://docs.stripe.com/api/subscriptions/object#subscription_object-collection_method)\n- [customer\nportal](https://docs.stripe.com/customer-management#customer-portal-features)\n- [customer portal\nsettings](https://dashboard.stripe.com/settings/billing/portal)\n- [Customer](https://docs.stripe.com/api/customers)\n- [Subscription](https://docs.stripe.com/api/subscription)\n- [Invoices](https://docs.stripe.com/api/invoice)\n- [configured failed payment\nlogic](https://docs.stripe.com/billing/subscriptions/overview#failed-payments)\n- [Stripe Checkout](https://docs.stripe.com/payments/checkout)\n- [Elements](https://docs.stripe.com/payments/elements)\n- [retrieve the initial invoice](https://docs.stripe.com/api/invoices/retrieve)\n-\n[metadata](https://docs.stripe.com/api/customers/object#customer_object-metadata)\n- [webhook](https://docs.stripe.com/webhooks)\n-\n[invoice.created](https://docs.stripe.com/api/events/types#event_types-invoice.created)\n- [Finalize the invoice manually](https://docs.stripe.com/api/invoices/finalize)\n-\n[invoice.finalized](https://docs.stripe.com/api/events/types#event_types-invoice.finalized)\n- [Listen to this event](https://docs.stripe.com/billing/subscriptions/webhooks)\n-\n[days_until_due](https://docs.stripe.com/api/subscriptions/object#subscription_object-days_until_due)\n-\n[customer.subscription.deleted](https://docs.stripe.com/api/events/types#event_types-customer.subscription.deleted)\n- [cancel the subscription](https://docs.stripe.com/api/subscriptions/cancel)\n- [Credit Notes](https://docs.stripe.com/api/credit_notes/object)\n-\n[out_of_band_amount](https://docs.stripe.com/api/credit_notes/create#create_credit_note-out_of_band_amount)\n- [setting up future\npayments](https://docs.stripe.com/payments/save-and-reuse?platform=checkout)\n- [Customer Portal](https://docs.stripe.com/no-code/customer-portal)\n-\n[collection_method](https://docs.stripe.com/api/subscriptions/update#update_subscription-collection_method)",
  "metadata": {
    "title": "Out-of-band invoices | Stripe Documentation",
    "description": "Learn how to mark invoices as paid off of Stripe.",
    "sourceURL": "https://docs.stripe.com/billing/subscriptions/out-of-band-invoices"
  }
}