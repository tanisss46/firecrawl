{
  "content": "# Migrate your basic card integration\n\n## Migrate to an integration that can handle bank requests for card authentication.\n\nIf you followed the [Card payments without bank\nauthentication](https://docs.stripe.com/payments/without-card-authentication)\nguide, your integration creates payments that decline when a bank asks the\ncustomer to authenticate the purchase.\n\nIf you start seeing many failed payments like the one in the Dashboard below or\nwith an error code of `requires_action_not_handled` in the API, upgrade your\nbasic integration to handle, rather than decline, these payments.\n\n![Dashboard showing a failed payment that says that this bank required\nauthentication for this\npayment](https://b.stripecdn.com/docs-statics-srv/assets/failed-payment-dashboard.9e22ec31f3c7063665911e26e389c5dc.png)\n\nUse this guide to learn how to upgrade the integration you built in the previous\nguide to add server and client code that prompts the customer to authenticate\nthe payment by displaying a modal.\n\n#### Note\n\nSee a [full\nsample](https://github.com/stripe-samples/accept-a-payment/tree/master/custom-payment-flow)\nof this integration on GitHub.\n\n[Check if the payment requires\nauthenticationServer-side](https://docs.stripe.com/payments/payment-intents/upgrade-to-handle-actions#update-server)\nMake two changes to the endpoint on your server that creates the PaymentIntent:\n\n- **Remove** the\n[error_on_requires_action](https://docs.stripe.com/api/payment_intents/create#create_payment_intent-error_on_requires_action)\nparameter to no longer fail payments that require authentication. Instead, the\nPaymentIntent status changes to `requires_action`.\n- **Add** the `confirmation_method` parameter to indicate that you want to\nexplicitly (manually) confirm the payment again on the server after handling\nauthentication requests.\n\n```\ncurl https://api.stripe.com/v1/payment_intents \\\n -u sk_test_BQokikJOvBiI2HlWgH4olfQ2: \\\n -d amount=1099 \\\n -d currency=usd \\\n -d payment_method_types[]=card \\\n -d confirm=true \\\n -d error_on_requires_action=true \\\n -d payment_method=\"{{PAYMENT_METHOD_ID}}\" \\\n -d confirmation_method=manual\n```\n\nThen update your “generate response” function to handle the `requires_action`\nstate instead of erroring:\n\n```\n# If the request succeeds, check the\n# PaymentIntent's `status` and handle\n# its `next_action`.\n```\n\n[Ask the customer to\nauthenticateClient-side](https://docs.stripe.com/payments/payment-intents/upgrade-to-handle-actions#update-client)\nNext, update your client-side code to tell Stripe to show a modal if the\ncustomer needs to authenticate.\n\nUse\n[stripe.handleCardAction](https://docs.stripe.com/js#stripe-handle-card-action)\nwhen a PaymentIntent has a status of `requires_action`. If successful, the\nPaymentIntent will have a status of `requires_confirmation` and you need to\nconfirm the PaymentIntent again on your server to finish the payment.\n\n```\nconst handleServerResponse = async (responseJson) => {\n if (responseJson.error) {\n // Show error from server on payment form\n } else if (responseJson.requiresAction) {\n // Use Stripe.js to handle the required card action\n const { error: errorAction, paymentIntent } =\n await stripe.handleCardAction(responseJson.clientSecret);\n\n if (errorAction) {\n // Show error from Stripe.js in payment form\n } else {\n // The card action has been handled\n // The PaymentIntent can be confirmed again on the server\n const serverResponse = await fetch('/pay', {\n method: 'POST',\n headers: { 'Content-Type': 'application/json' },\n body: JSON.stringify({ payment_intent_id: paymentIntent.id })\n });\n handleServerResponse(await serverResponse.json());\n }\n } else {\n // Show success message\n }\n}\n```\n\n[Confirm the PaymentIntent\nagainServer-side](https://docs.stripe.com/payments/payment-intents/upgrade-to-handle-actions#update-server-second-confirm)\nUsing the same endpoint you set up earlier, confirm the PaymentIntent again to\nfinalize the payment and fulfill the order. The payment attempt fails and\ntransitions back to `requires_payment_method` if it is not confirmed again\nwithin one hour.\n\n```\ncurl https://api.stripe.com/v1/payment_intents/{{PAYMENT_INTENT_ID}}/confirm \\\n -u sk_test_BQokikJOvBiI2HlWgH4olfQ2: \\\n -X \"POST\"\n```\n\n[Test the\nintegration](https://docs.stripe.com/payments/payment-intents/upgrade-to-handle-actions#test-manual)\nUse our test cards in a sandbox to verify that your integration was properly\nupdated. Stripe displays a fake authentication page inside the modal in a\nsandbox that lets you simulate a successful or failed authentication attempt. In\nlive mode the bank controls the UI of what is displayed inside the modal.\n\nNumberDescription4242424242424242Succeeds and immediately processes the\npayment.4000000000009995Always fails with a decline code of\n`insufficient_funds`.4000002500003155Requires authentication, which in this\nintegration will fail with a decline code of `authentication_not_handled`.\n\n## Links\n\n- [Card payments without bank\nauthentication](https://docs.stripe.com/payments/without-card-authentication)\n- [full\nsample](https://github.com/stripe-samples/accept-a-payment/tree/master/custom-payment-flow)\n-\n[error_on_requires_action](https://docs.stripe.com/api/payment_intents/create#create_payment_intent-error_on_requires_action)\n-\n[stripe.handleCardAction](https://docs.stripe.com/js#stripe-handle-card-action)",
  "metadata": {
    "title": "Migrate your basic card integration | Stripe Documentation",
    "description": "Migrate to an integration that can handle bank requests for card authentication.",
    "sourceURL": "https://docs.stripe.com/payments/payment-intents/upgrade-to-handle-actions"
  }
}