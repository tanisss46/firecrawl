{
  "content": "# Migrate to direct webhook response\n\n## Learn how to migrate Issuing real-time authorizations from API calls to direct webhook responses.\n\nYou can now [respond directly to a issuing_authorization.request\nwebhook](https://docs.stripe.com/issuing/controls/real-time-authorizations) with\na real-time authorization decision instead of making an API call to\n[approve](https://docs.stripe.com/api/issuing/authorizations/approve) and\n[decline](https://docs.stripe.com/api/issuing/authorizations/decline) endpoints\nduring the webhook.\n\nResponding directly to the webhook event simplifies real-time authorizations,\nand removes an extra API call that can negatively impact your authorization rate\nwith time outs.\n\nIf you’re building a new integration, use the new direct webhook response\ninstead of making approve and decline API calls. We are deprecating the approve\nand decline endpoints, but existing users will continue to have access until at\nleast the end of 2024. If you have an existing integration with real-time\nauthorization, plan to migrate to direct webhook responses.\n\n#### Note\n\nThis guide only applies if you use the `/approve` and `/decline` endpoints for\nreal-time authorizations.\n\n## Legacy API call flow\n\nPreviously, you needed to make an API call to `/approve` or `/decline` to make a\ndecision for an incoming authorization request before responding to the\n`issuing_authorization.request` webhook.\n\nCardholder\n\nStripe\n\nUser\n\nAttempt purchase\n\n`POST issuing_authorization.request`\n\nMake decision\n\n`POST /approve`\n\n200 Response to `/approve`\n\nClose webhook request\n\n200 Response to `issuing_authorization.request`\n\nPurchase approved\n\n## New direct webhook response flow\n\nYou can now respond directly to the `issuing_authorization.request` webhook with\na decision in the response body, without needing to make a separate API call.\nAfter the decision, an `issuing_authorization.created` or\n`issuing_authorization.updated` webhook event is still sent.\n\nLearn more about this API in the [real-time authorization\ndocumentation](https://docs.stripe.com/issuing/controls/real-time-authorizations),\nand build an integration with [our interactive\nguide](https://docs.stripe.com/issuing/controls/real-time-authorizations/quickstart).\n\nCardholder\n\nStripe\n\nUser\n\nAttempt purchase\n\n`POST issuing_authorization.request`\n\nMake decision\n\n200 Response to `issuing_authorization.request` `{approved: true}` and\n`Stripe-Version` header set\n\nPurchase approved\n\nYou must respond with an HTTP status code of `200`, a `Stripe-Version` header\nset to a specific API version, and a Boolean of `approved` in the JSON body. The\nJSON body must correspond with the [specified API\nversion](https://docs.stripe.com/api/versioning).\n\nFor controllable amount authorizations, [partial\napprovals](https://docs.stripe.com/issuing/purchases/authorizations?issuing-authorization-type=incremental_authorization#handling-other-authorizations)\noptionally include `amount`.\n\n### Direct webhook Authorization API changes\n\nFor direct webhook response\n[Authorizations](https://docs.stripe.com/api/issuing/authorizations/object),\nwe’ve made several additions:\n\n- Added value `webhook_error` to\n[request_history.reason](https://docs.stripe.com/api/issuing/authorizations/object#issuing_authorization_object-request_history-reason).\nThis value is present if the webhook response fails due to validation errors.\n- New field `request_history.reason_message`, which includes a detailed error\nmessage if the `request_history.reason` is `webhook_error`.\n\n## Migrate to direct response\n\nYou can try the direct webhook response in test mode. As a best practice, we\nrecommend gradually shifting over from the legacy API call to responding\ndirectly to the webhook.\n\nIf you call an API method and include the direct webhook response body, the API\nmethod decision takes priority.\n\nHere’s an example of what a migration to the direct webhook might look like in\nRuby. For other languages, see [our interactive\nguide](https://docs.stripe.com/issuing/controls/real-time-authorizations/quickstart).\n\n```\n# User's existing API call webhook handling code, using Sinatra.\n# In this example, the synchronous webhook and normal webhook share an endpoint.\npost '/webhook' do\n payload = request.body.read\n\n if event['type'] == 'issuing_authorization.request'\n auth = event['data']['object']\n # Approve with legacy API call.\n Stripe::Issuing::Authorization.approve(auth[\"id\"])\n status 200\n elsif event['type'] == 'issuing_authorization.created'\n auth = event['data']['object']\n # If approved, will print \"webhook_approved\"\n puts \"#{auth[\"request_history\"][-1][\"reason\"]}\"\n status 200\n end\nend\n```\n\nAfter testing in test mode, gradually shift traffic to the direct webhook\nresponse.\n\n```\n# User's API call and direct response webhook handling code, using Sinatra.\n# In this example, the synchronous webhook and normal webhook share an endpoint.\npost '/webhook' do\n payload = request.body.read\n\n if event['type'] == 'issuing_authorization.request'\n auth = event['data']['object']\n\n # Gradually shift traffic over from API approval to direct webhook response.\n if should_use_direct_webhook_response?(auth[\"id\"])\n # Direct webhook response.\n\n body {\n # Required field, containing decision.\n \"approved\": true,\n }.to_json\n\n header {\n# Required in header. Versions can be found in\nhttps://stripe.com/docs/api/versioning\n \"Stripe-Version\": \"2023-08-16\"\n }\n\n # Must respond with a 200.\n status 200\n else\n# Legacy API call. Plan to remove this after traffic is completely shifted.\n Stripe::Issuing::Authorization.approve(auth[\"id\"])\n status 200\n end\n elsif event['type'] == 'issuing_authorization.created'\n auth = event['data']['object']\n\n # If approved, will print \"webhook_approved\"\n puts \"#{auth[\"request_history\"][-1][\"reason\"]}\"\n\n # Handle new reason value and field\n if auth[\"request_history\"][-1][\"reason\"] == \"webhook_error\"\nputs \"Direct webhook response decision failed:\n#{auth[\"request_history\"][-1][\"reason_message\"]}\"\n end\n status 200\n end\nend\n```\n\n## Links\n\n- [respond directly to a issuing_authorization.request\nwebhook](https://docs.stripe.com/issuing/controls/real-time-authorizations)\n- [approve](https://docs.stripe.com/api/issuing/authorizations/approve)\n- [decline](https://docs.stripe.com/api/issuing/authorizations/decline)\n- [our interactive\nguide](https://docs.stripe.com/issuing/controls/real-time-authorizations/quickstart)\n- [specified API version](https://docs.stripe.com/api/versioning)\n- [partial\napprovals](https://docs.stripe.com/issuing/purchases/authorizations?issuing-authorization-type=incremental_authorization#handling-other-authorizations)\n- [Authorizations](https://docs.stripe.com/api/issuing/authorizations/object)\n-\n[request_history.reason](https://docs.stripe.com/api/issuing/authorizations/object#issuing_authorization_object-request_history-reason)\n-\n[https://stripe.com/docs/api/versioning](https://stripe.com/docs/api/versioning)",
  "metadata": {
    "title": "Migrate to direct webhook response | Stripe Documentation",
    "description": "Learn how to migrate Issuing real-time authorizations from API calls to direct webhook responses.",
    "sourceURL": "https://docs.stripe.com/issuing/controls/real-time-authorizations/direct-webhook-migration"
  }
}